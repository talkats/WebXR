<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fixed AR Test</title>
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1.3.0/dist/aframe-master.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        .ui-layer {
            position: fixed;
            z-index: 9999;
            pointer-events: auto;
        }

        #file-container {
            composes: ui-layer;
            top: env(safe-area-inset-top, 20px);
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            width: 80%;
            max-width: 300px;
        }

        #control-buttons {
            composes: ui-layer;
            bottom: env(safe-area-inset-bottom, 20px);
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            touch-action: none;
        }

        .btn {
            width: 60px;
            height: 60px;
            font-size: 24px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Force UI elements above AR scene */
        .a-canvas {
            z-index: 1 !important;
        }

        #file-input {
            font-size: 16px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="file-container" class="ui-layer">
        <input type="file" id="file-input" accept=".glb">
    </div>

    <div id="control-buttons" class="ui-layer">
        <button class="btn" id="scaleUpBtn">+</button>
        <button class="btn" id="scaleDownBtn">-</button>
        <button class="btn" id="rotateLeftBtn">←</button>
        <button class="btn" id="rotateRightBtn">→</button>
        <button class="btn" id="resetBtn">R</button>
    </div>

    <a-scene 
        embedded 
        vr-mode-ui="enabled: false"
        renderer="antialias: true; alpha: true; precision: mediump;"
        arjs="sourceType: webcam; 
              sourceWidth: 1280; 
              sourceHeight: 960; 
              displayWidth: 1280; 
              displayHeight: 960; 
              debugUIEnabled: false;
              detectionMode: mono;
              patternRatio: 0.75;">
        <a-marker preset="hiro" smooth="true" smoothCount="5">
            <a-entity id="model-container" 
                      position="0 0.5 0" 
                      scale="0.5 0.5 0.5"
                      rotation="0 0 0">
            </a-entity>
        </a-marker>
        <a-entity camera position="0 0 0"></a-entity>
    </a-scene>

    <script>
        const modelContainer = document.getElementById('model-container');
        const fileInput = document.getElementById('file-input');
        const buttons = document.querySelectorAll('.btn');
        let currentScale = 0.5;
        let currentRotation = 0;

        // Prevent AR.js from capturing these events
        buttons.forEach(btn => {
            ['touchstart', 'touchend', 'click'].forEach(evt => {
                btn.addEventListener(evt, e => {
                    e.stopPropagation();
                });
            });
        });

        fileInput.addEventListener('change', (event) => {
            event.stopPropagation();
            const file = event.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                modelContainer.setAttribute('gltf-model', url);
            }
        });

        document.getElementById('scaleUpBtn').onclick = (e) => {
            e.preventDefault();
            currentScale = Math.min(currentScale + 0.1, 2);
            updateTransform();
        };

        document.getElementById('scaleDownBtn').onclick = (e) => {
            e.preventDefault();
            currentScale = Math.max(currentScale - 0.1, 0.1);
            updateTransform();
        };

        document.getElementById('rotateLeftBtn').onclick = (e) => {
            e.preventDefault();
            currentRotation -= 45;
            updateTransform();
        };

        document.getElementById('rotateRightBtn').onclick = (e) => {
            e.preventDefault();
            currentRotation += 45;
            updateTransform();
        };

        document.getElementById('resetBtn').onclick = (e) => {
            e.preventDefault();
            currentScale = 0.5;
            currentRotation = 0;
            updateTransform();
        };

        function updateTransform() {
            modelContainer.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`);
            modelContainer.setAttribute('rotation', `0 ${currentRotation} 0`);
        }

        // Ensure UI is above AR scene after load
        window.addEventListener('load', () => {
            document.querySelectorAll('.ui-layer').forEach(el => {
                el.style.zIndex = '9999';
            });
        });
    </script>
</body>
</html>
